<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Typing Test â€“ Inhouse Software</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;700&family=Inter:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    /* ========= VARS & RESET ========= */
    :root {
      --bg-color: #050505;
      --card-bg: #141414;
      --card-border: #333333;
      --text-main: #f5f5f0;
      --text-muted: #888888;
      /* Accent Color for UI */
      --accent-color: #66BB6A;
      --accent-glow: rgba(102, 187, 106, 0.6); 
      --accent-copper: #d97736;
      --copper-glow: rgba(217, 119, 54, 0.6);
      --error: #EF5350;
      --error-glow: rgba(239, 83, 80, 0.6);
      
      --font-logo: 'Comfortaa', cursive;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg-color);
      background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, var(--bg-color) 70%);
      color: var(--text-main);
      font-family: var(--font-body);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100dvh; /* Dynamic viewport height */
      width: 100vw;
      padding: 1rem;
      overflow: hidden;
    }

    /* ========= LAYOUT ========= */
    .container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      padding: 2rem;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      backdrop-filter: blur(10px);
      z-index: 10;
      overflow: hidden;
    }

    /* ========= ANIMATIONS ========= */
    .mode {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      animation: fadeIn 0.4s ease forwards;
    }
    
    .mode.fading-out {
      animation: fadeOut 0.2s ease forwards;
      pointer-events: none;
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(10px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes fadeOut {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.98); }
    }

    /* ========= HEADER ========= */
    .typetest-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      flex-shrink: 0;
    }
    .typetest-icon {
      font-size: 3.5rem;
      color: var(--accent-color);
      filter: drop-shadow(0 0 8px var(--accent-glow));
    }
    .typetest-title {
      font-family: var(--font-logo);
      font-weight: 700;
      font-size: 2.8rem;
      color: var(--text-main);
      letter-spacing: -1px;
    }

    /* ========= FOOTER BRANDING ========= */
    .brand-footer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: absolute;
      bottom: 1rem;
      opacity: 0.5;
      transition: opacity 0.3s;
      z-index: 5;
    }
    .brand-footer:hover { opacity: 1; }
    
    .brand-logo {
      width: 24px; /* Smaller logo */
      height: 24px;
      stroke: var(--accent-copper);
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      stroke-linejoin: round;
      margin-bottom: 0.25rem;
      filter: drop-shadow(0 0 8px rgba(217, 119, 54, 0.2));
    }
    .brand-name {
      font-family: var(--font-logo);
      font-weight: 700;
      font-size: 0.75rem; /* Smaller font */
      color: var(--text-main);
      letter-spacing: -0.5px;
    }

    /* ========= STATS BAR ========= */
    .stats-bar {
      display: flex;
      width: 100%;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 12px;
      margin: 0 0 1rem 0;
      font-family: var(--font-mono);
      border: 1px solid rgba(255,255,255,0.05);
      flex-shrink: 0;
      transition: all 0.3s ease;
    }
    /* Hide stats bar when results are shown */
    .write-finished .stats-bar { display: none; }

    .stat-item { display: flex; flex-direction: column; }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }

    /* ========= WRITE MODE ========= */
    .timer-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      margin-bottom: 1.5rem;
      overflow: hidden;
      flex-shrink: 0;
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.5) inset;
      transition: all 0.3s ease;
    }
    .write-finished .timer-bar { display: none; }

    .timer-progress {
      height: 100%;
      width: 100%;
      background-color: var(--accent-color);
      box-shadow: 0 0 20px var(--accent-glow), 0 0 40px var(--accent-glow);
      transform-origin: left;
      transition: width 1s linear, background-color 1s ease-in-out, box-shadow 1s ease-in-out;
    }

    #writeMode .test-area {
      position: relative;
      background: rgba(0,0,0,0.2);
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      min-height: 160px;
      width: 100%;
      cursor: text;
      text-align: left;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      overflow-y: hidden;
      scroll-behavior: smooth;
      flex: 1; 
    }
    #writeMode .test-text {
      font-family: var(--font-mono);
      font-size: 1.4rem;
      line-height: 2rem;
      color: var(--text-muted);
      word-break: break-word;
      transition: opacity 0.5s ease, filter 0.5s ease;
      position: relative;
    }
    .word { display: inline-block; margin-right: 0.2ch; }
    .letter { position: relative; }
    .letter.correct { color: var(--text-main); }
    .letter.incorrect { color: var(--error); text-decoration: underline; }

    /* RESULTS */
    .write-finished .test-text, .write-finished #cursor { display: none; }
    .write-finished .test-area { 
        border-color: var(--accent-color);
        box-shadow: 0 0 30px rgba(102, 187, 106, 0.2);
        min-height: 300px; 
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.4); 
    }
    #resultsGraphic {
        display: none;
        width: 100%;
        height: 100%;
        flex-direction: column;
        gap: 1rem;
        animation: fadeIn 0.5s ease 0.2s forwards;
        opacity: 0;
    }
    .write-finished #resultsGraphic { display: flex; }
    
    .result-block {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--card-border);
        padding: 1rem;
        border-radius: 16px;
        text-align: center;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        position: relative;
        overflow: hidden;
    }
    .result-block::before {
        content: ''; position: absolute; inset: 0; border-radius: 16px; padding: 2px; 
        background: linear-gradient(45deg, var(--accent-color), transparent 60%);
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none;
    }
    .wpm-block .value { font-size: 4rem; font-weight: 700; color: var(--accent-color); text-shadow: 0 0 20px var(--accent-glow); }

    /* Cursor */
    #cursor {
      position: absolute;
      width: 2px;
      height: 1.2em;
      background-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
      transition: all 0.1s ease-out;
      pointer-events: none;
      z-index: 10;
    }

    /* ========= CHARACTER MODE ========= */
    #charCarousel {
      position: relative;
      height: 180px;
      width: 100%;
      margin: 20px 0;
      overflow: hidden;
      mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
      -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
      flex-shrink: 1;
    }
    .charItem {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-mono);
      font-weight: 700;
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .charItem.center { font-size: 8rem; color: var(--text-main); opacity: 1; z-index: 3; }
    .charItem.next { font-size: 4rem; color: var(--text-muted); opacity: 0.6; left: 70%; z-index: 2; }
    .charItem.next2 { font-size: 2.5rem; color: var(--text-muted); opacity: 0.3; left: 85%; z-index: 1; }
    .charItem.enter { font-size: 2.5rem; color: var(--text-muted); opacity: 0; left: 100%; z-index: 0; }
    .charItem.shake { animation: shake 0.3s; color: var(--error) !important; }
    @keyframes shake { 0%, 100% { transform: translate(-50%,-50%); } 25% { transform: translate(calc(-50% - 10px),-50%); } 75% { transform: translate(calc(-50% + 10px),-50%); } }

    /* Finger Diagram */
    .finger-diagram {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 1rem;
      flex-wrap: wrap;
      flex-shrink: 0;
    }
    .finger {
      padding: 6px 12px;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s;
      font-family: var(--font-mono);
    }
    .finger.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    /* Custom Checkbox */
    .options-bar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .custom-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 8px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      transition: 0.2s;
    }
    .custom-checkbox:hover { background: rgba(255,255,255,0.06); }
    .custom-checkbox input { display: none; }
    .checkbox-box { width: 18px; height: 18px; border: 2px solid var(--text-muted); border-radius: 4px; display: inline-block; position: relative; }
    .custom-checkbox input:checked + .checkbox-box { background: var(--accent-color); border-color: var(--accent-color); }
    .custom-checkbox input:checked + .checkbox-box::after {
      content: '';
      position: absolute;
      left: 5px; top: 1px;
      width: 4px; height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* ========= MODE SELECTOR (Home) ========= */
    .mode-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-top: 2rem;
      width: 100%;
    }
    .mode-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--card-border);
      padding: 1.5rem;
      border-radius: 16px;
      cursor: pointer;
      transition: 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .mode-btn:active, .mode-btn:hover { border-color: var(--accent-color); background: rgba(102, 187, 106, 0.1); }
    .mode-btn span { font-size: 2rem; color: var(--accent-color); }
    .mode-btn h3 { font-size: 1.1rem; color: var(--text-main); }
    .mode-btn small { font-size: 0.8rem; color: var(--text-muted); }

    /* ========= MOBILE INPUT ========= */
    #mobileInput { position: absolute; opacity: 0; top: -1000px; }
    .mobile-tap-area { position: absolute; inset: 0; z-index: 5; cursor: text; }

    .back-btn {
      align-self: flex-start;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: var(--font-body);
      font-size: 0.9rem;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
    }

    /* Restart Button */
    #restartBtn {
        margin: 1rem auto 0;
        padding: 12px 32px;
        background: var(--accent-copper);
        color: white;
        border: none;
        border-radius: 50px;
        font-family: var(--font-logo);
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 4px 15px var(--copper-glow);
        transition: transform 0.1s;
        display: none; /* Shown via JS */
    }
    #restartBtn:active { transform: scale(0.96); }

    /* ========= MOBILE SPECIFIC ========= */
    @media (max-width: 600px) {
      body { padding: 0.5rem; }
      
      .container {
        padding: 1rem;
        border-radius: 16px; /* Rounded by default */
        height: calc(100dvh - 1rem);
        justify-content: flex-start;
      }
      
      /* Hide Finger Diagram on Mobile */
      .finger-diagram { display: none; }

      /* -- KEYBOARD ACTIVE STATE -- */
      body.keyboard-active {
         padding: 0;
      }
      
      /* Container becomes full screen square when typing */
      body.keyboard-active .container {
         width: 100vw;
         height: 100dvh;
         max-height: 100dvh;
         border-radius: 0; 
         padding: 0.5rem;
         margin: 0;
         border: none;
         /* Use block to allow natural stacking */
         display: flex;
         flex-direction: column;
      }

      /* Hide non-essentials when keyboard is open */
      body.keyboard-active .typetest-header,
      body.keyboard-active .brand-footer,
      body.keyboard-active .back-btn,
      body.keyboard-active #writeNotice,
      body.keyboard-active #charNotice {
        display: none !important;
      }
      
      /* COMPACT Stats */
      body.keyboard-active .stats-bar {
        padding: 0.25rem 0.5rem;
        margin: 0 0 0.5rem 0;
        flex-shrink: 0;
        height: auto;
        min-height: 40px;
      }
      body.keyboard-active .stat-item {
        flex-direction: row;
        gap: 5px;
        align-items: baseline;
      }
      body.keyboard-active .stat-label { font-size: 0.7rem; }
      body.keyboard-active .stat-value { font-size: 1rem; }

      /* MAXIMIZE WRITE AREA - SCOPED TO WRITE MODE */
      body.mode-write.keyboard-active #writeMode {
        display: flex !important;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
      }
      body.mode-write.keyboard-active #writeMode .test-area {
        flex: 1;
        max-height: none;
        padding: 0.75rem;
        margin-bottom: 5px;
        overflow-y: auto;
      }
      /* Smaller Text for Mobile Write Mode */
      body.mode-write.keyboard-active #writeMode .test-text {
        font-size: 0.85rem; /* Reduced further for fitting */
        line-height: 1.3;
      }
      body.mode-write.keyboard-active .timer-bar {
        margin-bottom: 0.5rem;
        height: 4px;
      }
      
      /* CHARACTER MODE ADJUSTMENT */
      body.mode-character.keyboard-active .container {
          justify-content: flex-start; /* Push to top */
          padding-top: 10px;
      }
      body.mode-character.keyboard-active #characterMode {
        display: flex !important;
        flex-direction: column;
        justify-content: flex-start; /* Start from top */
        height: 100%;
        gap: 10px;
      }
      body.mode-character.keyboard-active #charCarousel {
        height: 100px; /* Drastically reduced height */
        margin: 0;
        overflow: hidden; 
        flex-shrink: 0;
      }
      
      /* Scale down char font sizes to fit */
      body.mode-character.keyboard-active .charItem { top: 40%; } /* Lift up */
      body.mode-character.keyboard-active .charItem.center { font-size: 3.5rem; z-index: 10;}
      body.mode-character.keyboard-active .charItem.next { font-size: 1.5rem; left: 75%; z-index: 5; }
      body.mode-character.keyboard-active .charItem.next2 { font-size: 1rem; left: 90%; z-index: 1; }
      
      /* Move stats to top via order */
      body.mode-character.keyboard-active .stats-bar {
        order: -1;
        margin-bottom: 0.5rem;
      }
      
      /* Keep Options Bar visible but compact */
      body.keyboard-active .options-bar {
        margin: 0;
        transform: scale(0.85);
        transform-origin: center top;
      }
      
      /* Ensure strict hiding of other modes */
      body.mode-character.keyboard-active #writeMode { display: none !important; }
      body.mode-write.keyboard-active #characterMode { display: none !important; }
    }
  </style>
</head>
<body class="mode-landing"> <!-- Default class -->

  <input type="text" id="mobileInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <div class="container">
    
    <div class="typetest-header">
      <span class="material-symbols-rounded typetest-icon">keyboard_alt</span>
      <span class="typetest-title">TypeTest</span>
    </div>

    <!-- Landing -->
    <div id="landingPage" class="mode">
      <p style="margin-bottom: 1.5rem;">Test your speed and accuracy.</p>
      <div class="mode-selector">
        <div class="mode-btn" onclick="setMode('write')">
          <span class="material-symbols-rounded">article</span>
          <h3>Write Mode</h3>
          <small>Press W</small>
        </div>
        <div class="mode-btn" onclick="setMode('character')">
          <span class="material-symbols-rounded">keyboard</span>
          <h3>Character Mode</h3>
          <small>Press C</small>
        </div>
      </div>
    </div>

    <!-- Write Mode -->
    <div id="writeMode" class="mode" style="display: none;">
      <button class="back-btn" onclick="setMode('landing')">
        <span class="material-symbols-rounded" style="font-size:18px;">arrow_back</span> Back
      </button>

      <div class="stats-bar">
        <div class="stat-item"><span class="stat-label">Time</span><span class="stat-value" id="writeTimer">30</span></div>
        <div class="stat-item"><span class="stat-label">WPM</span><span class="stat-value" id="writeWpm">0</span></div>
        <div class="stat-item"><span class="stat-label">ACC</span><span class="stat-value" id="writeAcc">100%</span></div>
      </div>

      <div class="timer-bar"><div class="timer-progress" id="timerProgress"></div></div>

      <div class="test-area" id="writeArea">
        <div class="mobile-tap-area" onclick="focusInput()"></div>
        <div class="test-text" id="writeTestText"></div>
        <!-- Results Overlay -->
        <div id="resultsGraphic">
            <div class="result-block wpm-block">
                <div style="font-size:0.8rem; color:#888; letter-spacing:1px;">WORDS PER MINUTE</div>
                <div class="value" id="finalWpm">0</div>
            </div>
            <div class="result-block accuracy-block" style="flex:0 auto;">
                <div style="font-size:0.8rem; color:#888; letter-spacing:1px; margin-bottom:0.5rem;">ACCURACY</div>
                <div style="height:20px; background:rgba(255,255,255,0.1); border-radius:10px; position:relative; width:100%;">
                    <div id="finalAccBar" style="height:100%; width:0%; background:#66BB6A; border-radius:10px; transition:width 1s ease;"></div>
                    <span id="finalAccValue" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); font-size:0.8rem; color:white; font-weight:700;">100%</span>
                </div>
            </div>
        </div>
      </div>
      
      <p id="writeNotice" style="margin-top: 1rem; font-size: 0.9rem; opacity:0.7;">Tap text to start</p>
      <button id="restartBtn" onclick="initWriteMode()">Restart Test</button>
    </div>

    <!-- Character Mode -->
    <div id="characterMode" class="mode" style="display: none;">
      <button class="back-btn" onclick="setMode('landing')">
        <span class="material-symbols-rounded" style="font-size:18px;">arrow_back</span> Back
      </button>

      <div class="options-bar">
        <label class="custom-checkbox">
          <input type="checkbox" id="includeNumbersCheckbox" checked>
          <span class="checkbox-box"></span>
          Include Numbers
        </label>
      </div>

      <div style="position:relative; width: 100%;" onclick="focusInput()">
        <div id="charCarousel"></div>
      </div>

      <div class="stats-bar">
        <div class="stat-item"><span class="stat-label">WPM</span><span class="stat-value" id="charWpm">0</span></div>
        <div class="stat-item"><span class="stat-label">CPS</span><span class="stat-value" id="charCps">0.00</span></div>
      </div>

      <p id="charNotice" style="margin-top: 1rem; font-size: 0.9rem; opacity:0.7;">Tap letter to start</p>
    </div>

  </div>

  <div class="brand-footer">
    <svg class="brand-logo" viewBox="0 0 100 60">
        <path d="M5 55 L50 10 L95 55" />
    </svg>
    <span class="brand-name">inhouse software</span>
  </div>

  <script>
    let currentMode = "landing";
    const mobileInput = document.getElementById("mobileInput");
    let transitionTimeout = null;
    let isTransitioning = false;
    
    function focusInput() {
      mobileInput.focus();
      mobileInput.value = ""; 
    }

    // Mobile Layout Triggers
    mobileInput.addEventListener('focus', () => {
        document.body.classList.add('keyboard-active');
    });
    mobileInput.addEventListener('blur', () => {
        document.body.classList.remove('keyboard-active');
    });

    function setMode(mode) {
      if (currentMode === mode || isTransitioning) return;
      isTransitioning = true;

      const container = document.querySelector('.container');
      const oldId = currentMode === 'landing' ? 'landingPage' : currentMode + 'Mode';
      const newId = mode === 'landing' ? 'landingPage' : mode + 'Mode';
      const oldEl = document.getElementById(oldId);
      const newEl = document.getElementById(newId);

      // Switch Body Classes immediately for CSS scoping
      document.body.classList.remove('mode-landing', 'mode-write', 'mode-character');
      document.body.classList.add('mode-' + mode);

      const startHeight = container.offsetHeight;
      container.style.height = startHeight + 'px';
      
      oldEl.classList.add('fading-out');

      setTimeout(() => {
        oldEl.style.display = 'none';
        oldEl.classList.remove('fading-out');
        
        stopWriteMode();
        if (charStatsInterval) { clearInterval(charStatsInterval); charStatsInterval = null; }
        mobileInput.value = "";

        currentMode = mode;
        if (mode === 'landing') mobileInput.blur();
        
        newEl.style.display = 'flex'; // Ensure flex layout for centering
        
        if (mode === 'write') { initWriteMode(); setTimeout(focusInput, 50); }
        else if (mode === 'character') { initCharacterMode(); setTimeout(focusInput, 50); }

        container.style.height = 'auto'; 
        const endHeight = container.offsetHeight;
        
        container.style.height = startHeight + 'px';
        void container.offsetHeight; 
        
        container.style.height = endHeight + 'px';
        
        if (transitionTimeout) clearTimeout(transitionTimeout);
        transitionTimeout = setTimeout(() => {
            container.style.height = 'auto';
            isTransitioning = false;
        }, 300);

      }, 200);
    }

    document.addEventListener("keydown", function(e) {
      if (isTransitioning) return;
      if (e.key === "Escape") { setMode("landing"); return; }
      if (document.activeElement === mobileInput) return;
      
      if (currentMode === "character" && e.key === "-") {
        const cb = document.getElementById("includeNumbersCheckbox");
        cb.checked = !cb.checked;
        initCharacterMode();
        return;
      }
      
      if (currentMode === "landing") {
        if (e.key.toLowerCase() === "w") { setMode("write"); return; }
        if (e.key.toLowerCase() === "c") { setMode("character"); return; }
      }
      
      if (currentMode === "write") handleWriteKey(e.key);
      else if (currentMode === "character") handleCharacterKey(e.key);
    });

    mobileInput.addEventListener("input", (e) => {
      const char = mobileInput.value.slice(-1);
      if (currentMode === "write") handleWriteKey(char);
      else if (currentMode === "character") handleCharacterKey(char);
      mobileInput.value = ""; 
    });

    mobileInput.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && currentMode === "write") handleWriteKey("Backspace");
    });

    /* WRITE MODE LOGIC */
    let writeCurrentText = "";
    let writeTypedText = "";
    const writeTimerDuration = 30;
    let writeTimeLeft = writeTimerDuration;
    let writeTimerInterval = null;
    let writeTestStarted = false;
    let writeTestEnded = false;
    let writeStartTime = null;
    
    const masterWordPool = ['time','person','year','way','day','thing','man','world','life','hand','part','child','eye','woman','place','work','week','case','point','government','company','number','group','problem','fact','night','water','room','mother','area','money','story','friend','love','car','tree','computer','phone','code','program','design','language','art','music','video','film','photo','game','play','park','home','house','city','country','ocean','mountain','river','forest','desert','sky','sun','moon','star','planet','space','universe','energy','force','power','light','dark','wind','fire','earth','metal','glass','stone','wood','air','silver','gold','copper','iron','mercury','diamond','crystal','cloud','rain','snow','ice','storm','calm','whisper','echo','shadow','reflection','silence','sound','noise','chatter','breeze','wave','tide','think','great','small','large','found','write','read','learn','build','watch','happy','angry','quick','slow','heavy','light','green','blue','red','white','black','north','south','east','west','start','finish','under','above','close','open','table','chair','paper','pencil','music','movie','pixel','screen','mouse','click','press','enter','shift','control','escape','delete','insert','logic','magic','dream','sleep','awake','focus','speed','count','score','level','stage','boss','fight','peace','trust','truth','false','wrong','right','check','habit','cycle','orbit','solar','lunar','polar','ocean','beach','sand','dune','hill','field','grass','leaf','root'];

    function generateParagraph(wordCount) {
      const shuffled = [...masterWordPool];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled.slice(0, wordCount).join(" ");
    }
    
    function renderWriteTestText() {
      const container = document.getElementById("writeTestText");
      container.innerHTML = "";
      const cursor = document.createElement("div");
      cursor.id = "cursor";
      container.appendChild(cursor);

      const words = writeCurrentText.split(" ");
      words.forEach((word, wIndex) => {
        const wordSpan = document.createElement("span");
        wordSpan.classList.add("word");
        for (let i = 0; i < word.length; i++) {
          const letterSpan = document.createElement("span");
          letterSpan.classList.add("letter");
          letterSpan.textContent = word[i];
          wordSpan.appendChild(letterSpan);
        }
        if (wIndex < words.length - 1) {
          const spaceSpan = document.createElement("span");
          spaceSpan.classList.add("letter");
          spaceSpan.innerHTML = "&nbsp;"; 
          wordSpan.appendChild(spaceSpan);
        }
        container.appendChild(wordSpan);
      });
      requestAnimationFrame(updateCursorPosition);
    }
    
    function updateCursorPosition() {
      const letters = document.querySelectorAll("#writeTestText .letter");
      const cursor = document.getElementById("cursor");
      const container = document.getElementById("writeArea");
      
      if (writeTypedText.length < letters.length) {
        const currentLetter = letters[writeTypedText.length];
        cursor.style.left = currentLetter.offsetLeft + 'px';
        cursor.style.top = currentLetter.offsetTop + 'px';
        cursor.style.height = currentLetter.offsetHeight + 'px'; 
        cursor.style.opacity = 1;

        // Auto-Scroll
        const letterTop = currentLetter.offsetTop;
        const containerHeight = container.clientHeight;
        const scrollTop = container.scrollTop;

        if (letterTop > scrollTop + containerHeight - 40) {
             container.scrollTo({ top: letterTop - 40, behavior: 'smooth' });
        } else if (letterTop < scrollTop) {
             container.scrollTo({ top: letterTop - 40, behavior: 'smooth' });
        }
      } else {
        cursor.style.opacity = 0;
      }
    }
    
    function calculateFinalStats() {
        const letters = document.querySelectorAll("#writeTestText .letter");
        let correctCount = 0;
        for (let i = 0; i < writeTypedText.length; i++) {
             if (writeTypedText[i] === letters[i].textContent.replace(/\u00a0/, " ")) correctCount++;
        }
        let elapsed = (Date.now() - writeStartTime) / 1000;
        elapsed = Math.max(elapsed, writeTimerDuration); 
        const accuracy = writeTypedText.length ? Math.round((correctCount / writeTypedText.length) * 100) : 0;
        const wpm = Math.round((correctCount / 5) / (elapsed / 60));
        return { wpm, accuracy };
    }

    function updateWriteStats() {
      if (writeTestEnded) return;
      const letters = document.querySelectorAll("#writeTestText .letter");
      let correctCount = 0;
      for (let i = 0; i < letters.length; i++) {
        const expected = letters[i].textContent.replace(/\u00a0/, " "); 
        const typedChar = writeTypedText[i];
        letters[i].className = "letter"; 
        if (typedChar != null) {
            if (typedChar === expected) { letters[i].classList.add("correct"); correctCount++; }
            else { letters[i].classList.add("incorrect"); }
        }
      }
      let elapsed = 0;
      if (writeStartTime) elapsed = (Date.now() - writeStartTime) / 1000;
      const accuracy = writeTypedText.length ? Math.round((correctCount / writeTypedText.length) * 100) : 100;
      const wpm = elapsed > 0 ? Math.round((correctCount / 5) / (elapsed / 60)) : 0;
      document.getElementById("writeWpm").textContent = wpm;
      document.getElementById("writeAcc").textContent = accuracy + "%";
    }
    
    function startWriteTimer() {
      writeTimerInterval = setInterval(() => {
        writeTimeLeft--;
        document.getElementById("writeTimer").textContent = writeTimeLeft;
        const pct = (writeTimeLeft / writeTimerDuration) * 100;
        const bar = document.getElementById("timerProgress");
        bar.style.width = pct + "%";
        if (writeTimeLeft <= 10) {
            bar.style.backgroundColor = "var(--accent-copper)";
            bar.style.boxShadow = "0 0 20px var(--copper-glow), 0 0 40px var(--copper-glow)";
        }
        if (writeTimeLeft <= 5) {
            bar.style.backgroundColor = "var(--error)";
            bar.style.boxShadow = "0 0 20px var(--error-glow), 0 0 40px var(--error-glow)";
        }
        if (writeTimeLeft <= 0) endWriteMode();
      }, 1000);
    }
    
    function endWriteMode() {
      clearInterval(writeTimerInterval);
      writeTestEnded = true;
      document.getElementById("writeNotice").textContent = "";
      mobileInput.blur(); 
      document.getElementById("writeMode").classList.add("write-finished");
      const { wpm, accuracy } = calculateFinalStats();
      document.getElementById("finalWpm").textContent = wpm;
      document.getElementById("finalAccValue").textContent = accuracy + "%";
      setTimeout(() => { document.getElementById("finalAccBar").style.width = accuracy + "%"; }, 100);
      document.getElementById("restartBtn").style.display = "block";
    }
    
    function stopWriteMode() { clearInterval(writeTimerInterval); }
    
    function initWriteMode() {
      writeCurrentText = generateParagraph(60); // More words for scrolling check
      writeTypedText = "";
      writeTimeLeft = writeTimerDuration;
      writeTestStarted = false;
      writeTestEnded = false;
      writeStartTime = null;
      document.getElementById("writeTimer").textContent = writeTimerDuration;
      document.getElementById("writeWpm").textContent = "0";
      document.getElementById("writeAcc").textContent = "100%";
      document.getElementById("writeNotice").textContent = "Tap text to start typing";
      document.getElementById("writeMode").classList.remove("write-finished");
      document.getElementById("restartBtn").style.display = "none";
      const bar = document.getElementById("timerProgress");
      bar.style.transition = "none"; bar.style.width = "100%"; bar.style.backgroundColor = ""; bar.style.boxShadow = ""; 
      void bar.offsetWidth; bar.style.transition = "width 1s linear, background-color 1s ease-in-out, box-shadow 1s ease-in-out";
      document.getElementById("finalAccBar").style.width = "0%";
      renderWriteTestText();
    }
    
    function handleWriteKey(key) {
      if (writeTestEnded) return;
      if (!writeTestStarted) {
        writeTestStarted = true;
        writeStartTime = Date.now();
        startWriteTimer();
      }
      if (key === "Backspace") writeTypedText = writeTypedText.slice(0, -1);
      else if (key.length === 1) writeTypedText += key;
      
      updateWriteStats(); 
      updateCursorPosition();
      const totalLetters = document.querySelectorAll("#writeTestText .letter").length;
      if (writeTypedText.length >= totalLetters) endWriteMode();
    }
    
    /* CHARACTER MODE LOGIC */
    let charTestStarted = false;
    let charStartTime = null;
    let charCorrectCount = 0;
    let charLastKeyTime = null;
    let charStatsInterval = null;
    let charQueue = [];
    
    function getAllowedChars() {
      const includeNumbers = document.getElementById("includeNumbersCheckbox").checked;
      return includeNumbers ? "abcdefghijklmnopqrstuvwxyz0123456789" : "abcdefghijklmnopqrstuvwxyz";
    }
    function getRandomChar() {
      const chars = getAllowedChars();
      return chars[Math.floor(Math.random() * chars.length)];
    }
    function renderCarousel() {
      const container = document.getElementById("charCarousel");
      container.innerHTML = "";
      const item0 = document.createElement("div"); item0.className = "charItem center"; item0.textContent = charQueue[0].toUpperCase();
      const item1 = document.createElement("div"); item1.className = "charItem next"; item1.textContent = charQueue[1].toUpperCase();
      const item2 = document.createElement("div"); item2.className = "charItem next2"; item2.textContent = charQueue[2].toUpperCase();
      container.appendChild(item0); container.appendChild(item1); container.appendChild(item2);
    }
    
    function updateCharStatsContinuous() {
      if (!charTestStarted) return;
      const now = Date.now();
      if (now - charLastKeyTime > 3000) {
        charTestStarted = false; charStartTime = null; charCorrectCount = 0;
        document.getElementById("charWpm").textContent = "0";
        document.getElementById("charWpm").style.color = "var(--text-muted)";
        return;
      } else {
        document.getElementById("charWpm").style.color = "var(--accent-color)";
      }
      const elapsed = (now - charStartTime) / 1000;
      const cps = elapsed > 0 ? (charCorrectCount / elapsed).toFixed(2) : "0.00";
      const wpm = elapsed > 0 ? ((charCorrectCount / 5) / (elapsed / 60)).toFixed(0) : "0";
      document.getElementById("charWpm").textContent = wpm;
      document.getElementById("charCps").textContent = cps;
    }
    
    function initCharacterMode() {
      charQueue = [getRandomChar(), getRandomChar(), getRandomChar()];
      renderCarousel();
      charTestStarted = false; charStartTime = null; charCorrectCount = 0; charLastKeyTime = null;
      document.getElementById("charWpm").textContent = "0";
      document.getElementById("charCps").textContent = "0.00";
      if (charStatsInterval) clearInterval(charStatsInterval);
      charStatsInterval = setInterval(updateCharStatsContinuous, 100);
    }
    
    function handleCharacterKey(key) {
      if (key.length !== 1) return;
      if (!charTestStarted) { charTestStarted = true; charStartTime = Date.now(); }
      charLastKeyTime = Date.now();
      if (key.toLowerCase() === charQueue[0].toLowerCase()) {
        charCorrectCount++;
        shiftCarousel();
      } else {
        const centerItem = document.querySelector(".charItem.center");
        centerItem.classList.remove("shake");
        void centerItem.offsetWidth; 
        centerItem.classList.add("shake");
      }
    }
    
    function shiftCarousel() {
      const container = document.getElementById("charCarousel");
      if (container.children.length < 3) return;
      container.removeChild(container.children[0]);
      const newCenter = container.children[0]; newCenter.classList.remove("next"); newCenter.classList.add("center");
      const newNext = container.children[1]; newNext.classList.remove("next2"); newNext.classList.add("next");
      charQueue.shift();
      const newChar = getRandomChar(); charQueue.push(newChar);
      const newItem = document.createElement("div"); newItem.className = "charItem enter"; newItem.textContent = newChar.toUpperCase();
      container.appendChild(newItem);
      void newItem.offsetWidth; 
      newItem.classList.remove("enter"); newItem.classList.add("next2");
    }
    
    document.getElementById("includeNumbersCheckbox").addEventListener("change", initCharacterMode);
    setMode("landing");
  </script>
</body>
</html>
