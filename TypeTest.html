<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Typing Test – Inhouse Software</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;700&family=Inter:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    /* ========= VARS & RESET ========= */
    :root {
      --bg-color: #050505;
      --card-bg: #141414;
      --card-border: #333333;
      --text-main: #f5f5f0;
      --text-muted: #888888;
      /* Accent Color for UI */
      --accent-color: #66BB6A;
      --accent-glow: rgba(102, 187, 106, 0.3);
      /* Accent Color for Logo */
      --accent-copper: #d97736;
      
      --success: #66BB6A;
      --error: #EF5350;
      --font-logo: 'Comfortaa', cursive;
      --font-body: 'Inter', sans-serif;
      --font-mono: 'Roboto Mono', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background-color: var(--bg-color);
      background-image: radial-gradient(circle at 50% 0%, #1a1a1a 0%, var(--bg-color) 70%);
      color: var(--text-main);
      font-family: var(--font-body);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
      overflow-x: hidden;
    }

    /* ========= LAYOUT ========= */
    .container {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      padding: 2rem;
      border-radius: 24px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      width: 100%;
      max-width: 900px;
      text-align: center;
      position: relative;
      /* Smooth container resizing */
      transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      backdrop-filter: blur(10px);
      z-index: 10;
      overflow: hidden;
    }

    /* ========= ANIMATIONS ========= */
    .mode {
      /* Default state for any visible mode */
      animation: fadeIn 0.4s ease forwards;
    }
    
    .mode.fading-out {
      animation: fadeOut 0.2s ease forwards;
      pointer-events: none; /* Prevent clicks during fade out */
    }

    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(10px) scale(0.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    @keyframes fadeOut {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0.98); }
    }

    /* ========= TYPETEST HEADER ========= */
    .typetest-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .typetest-icon {
      font-size: 3.5rem;
      color: var(--accent-color);
      filter: drop-shadow(0 0 8px var(--accent-glow));
    }
    .typetest-title {
      font-family: var(--font-logo);
      font-weight: 700;
      font-size: 2.8rem;
      color: var(--text-main);
      letter-spacing: -1px;
    }

    /* ========= BRANDING FOOTER ========= */
    .brand-footer {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 3rem; /* Space from the main box */
      opacity: 0.6;
      transition: opacity 0.3s;
    }
    .brand-footer:hover {
      opacity: 1;
    }
    .brand-logo {
      width: 48px;
      height: 48px;
      stroke: var(--accent-copper);
      fill: none;
      stroke-width: 5;
      stroke-linecap: round;
      stroke-linejoin: round;
      margin-bottom: 0.5rem;
      filter: drop-shadow(0 0 10px rgba(217, 119, 54, 0.3));
    }
    .brand-name {
      font-family: var(--font-logo);
      font-weight: 700;
      font-size: 1.2rem;
      color: var(--text-main);
      letter-spacing: -0.5px;
    }

    /* ========= TYPOGRAPHY ========= */
    h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      letter-spacing: -0.02em;
    }
    p { color: var(--text-muted); line-height: 1.6; }
    
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.03);
      padding: 1rem;
      border-radius: 12px;
      margin: 1.5rem 0;
      font-family: var(--font-mono);
      border: 1px solid rgba(255,255,255,0.05);
    }
    .stat-item {
      display: flex;
      flex-direction: column;
    }
    .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--accent-color); }

    /* ========= INTERACTIVE ELEMENTS ========= */
    .mode-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin: 2rem 0;
    }
    
    .mode-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--card-border);
      padding: 1.5rem;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .mode-btn:hover {
      background: rgba(102, 187, 106, 0.1);
      border-color: var(--accent-color);
      transform: translateY(-2px);
    }
    .mode-btn span { font-size: 2rem; color: var(--accent-color); }
    .mode-btn h3 { font-size: 1.1rem; font-weight: 600; }
    .mode-btn small { font-size: 0.8rem; color: var(--text-muted); }

    /* ========= WRITE MODE ========= */
    #writeMode .test-area {
      position: relative;
      background: rgba(0,0,0,0.2);
      padding: 1.5rem;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      min-height: 160px;
      cursor: text;
      text-align: left;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      /* Scroll behavior */
      overflow-y: hidden; /* Desktop default */
      scroll-behavior: smooth;
    }
    #writeMode .test-text {
      font-family: var(--font-mono);
      font-size: 1.4rem;
      line-height: 2rem;
      color: var(--text-muted);
      word-break: break-word;
      transition: opacity 0.5s ease, filter 0.5s ease;
      position: relative; /* Context for cursor */
    }
    .word { display: inline-block; margin-right: 0.2ch; }
    .letter { position: relative; }
    .letter.correct { color: var(--text-main); }
    .letter.incorrect { color: var(--error); text-decoration: underline; }
    
    /* FINISHED STATE ANIMATIONS */
    @keyframes timeUpPulse {
      0% { transform: scale(1); border-color: var(--card-border); }
      50% { transform: scale(1.02); border-color: var(--error); box-shadow: 0 0 20px rgba(239, 83, 80, 0.3); }
      100% { transform: scale(1); border-color: var(--card-border); }
    }

    .write-finished .test-area { animation: timeUpPulse 0.5s ease-out; }
    .write-finished .test-text { opacity: 0.3; filter: grayscale(1); }
    
    /* Smooth Caret */
    #cursor {
      position: absolute;
      width: 2px;
      height: 1.2em; 
      background-color: var(--accent-color);
      box-shadow: 0 0 8px var(--accent-color);
      transition: all 0.1s ease-out;
      pointer-events: none;
      z-index: 10;
    }

    /* ========= CHARACTER MODE ========= */
    #charCarousel {
      position: relative;
      height: 180px;
      margin: 20px 0;
      overflow: hidden;
      /* Adjusted mask to ensure right-side items are visible */
      mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
      -webkit-mask-image: linear-gradient(to right, transparent, black 15%, black 85%, transparent);
    }
    .charItem {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: var(--font-mono);
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .charItem.center { font-size: 8rem; color: var(--text-main); opacity: 1; z-index: 3; }
    
    /* Adjusted positions to bring characters closer together */
    .charItem.next { 
      font-size: 4rem; 
      color: var(--text-muted); 
      opacity: 0.6; 
      left: 68%; /* Brought closer from 75% */
      z-index: 2; 
    }
    .charItem.next2 { 
      font-size: 2.5rem; 
      color: var(--text-muted); 
      opacity: 0.3; 
      left: 82%; /* Brought closer from 90% */
      z-index: 1; 
    }
    
    /* New entry state for smooth fade-in */
    .charItem.enter {
      font-size: 2.5rem;
      color: var(--text-muted);
      opacity: 0;
      left: 100%;
      z-index: 0;
    }
    
    /* Animation state for incorrect */
    .charItem.shake { animation: shake 0.3s ease-in-out; color: var(--error) !important; }
    
    @keyframes shake {
      0%, 100% { transform: translate(-50%, -50%); }
      25% { transform: translate(calc(-50% - 10px), -50%); }
      75% { transform: translate(calc(-50% + 10px), -50%); }
    }

    /* Finger Diagram */
    .finger-diagram {
      display: flex;
      justify-content: center;
      gap: 4px;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    .finger {
      padding: 6px 12px;
      border: 1px solid var(--card-border);
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      transition: all 0.2s;
      font-family: var(--font-mono);
    }
    .finger.active {
      background: var(--accent-color);
      color: white;
      border-color: var(--accent-color);
      transform: translateY(-4px);
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    /* Custom Checkbox */
    .options-bar {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .custom-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      color: var(--text-muted);
      padding: 8px 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 20px;
      transition: 0.2s;
    }
    .custom-checkbox:hover { background: rgba(255,255,255,0.06); }
    .custom-checkbox input { display: none; }
    .checkbox-box {
      width: 18px; height: 18px;
      border: 2px solid var(--text-muted);
      border-radius: 4px;
      position: relative;
      transition: 0.2s;
    }
    .custom-checkbox input:checked + .checkbox-box {
      background: var(--accent-color);
      border-color: var(--accent-color);
    }
    .custom-checkbox input:checked + .checkbox-box::after {
      content: '';
      position: absolute;
      left: 5px; top: 1px;
      width: 4px; height: 9px;
      border: solid white;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* HIDDEN INPUT FOR MOBILE KEYBOARD */
    #mobileInput { position: absolute; opacity: 0; top: -1000px; }
    .mobile-tap-area { position: absolute; inset: 0; z-index: 5; cursor: text; }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-family: var(--font-body);
      font-size: 0.9rem;
      padding: 8px;
      border-radius: 8px;
      transition: 0.2s;
    }
    .back-btn:hover { background: rgba(255,255,255,0.05); color: var(--text-main); }

    /* RESPONSIVE & MOBILE KEYBOARD FIXES */
    @media (max-width: 600px) {
      .container { padding: 1.5rem 1rem; border-radius: 0; min-height: 100vh; border: none; display: flex; flex-direction: column; justify-content: center; }
      h1 { font-size: 1.6rem; }
      .mode-selector { grid-template-columns: 1fr; }
      .finger-diagram { display: none; }
      .charItem.center { font-size: 5rem; }
      #writeMode .test-text { font-size: 1.1rem; }
      .back-btn { top: 10px; left: 10px; }
      
      /* Mobile Text Area - Scrollable with Limit */
      #writeMode .test-area {
        max-height: 180px; 
        overflow-y: auto; /* Allow manual scrolling too */
      }

      /* Mobile Keyboard Focus State 
         Activated via JS class 'keyboard-active' on body
      */
      body.keyboard-active {
        align-items: flex-start; /* Move everything to top */
        padding: 0;
      }
      body.keyboard-active .container {
        position: fixed;
        inset: 0;
        z-index: 999;
        height: 100%;
        padding: 10px;
        background: var(--bg-color); /* Cover background */
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
      }
      /* HIDE Elements when keyboard is open */
      body.keyboard-active .typetest-header,
      body.keyboard-active .brand-footer,
      body.keyboard-active .back-btn,
      body.keyboard-active #writeNotice,
      body.keyboard-active .options-bar,
      body.keyboard-active #charNotice {
        display: none !important;
      }
      
      /* COMPACT Stats */
      body.keyboard-active .stats-bar {
        padding: 0.5rem;
        margin: 0.5rem 0;
        flex-shrink: 0;
      }
      body.keyboard-active .stat-item {
        flex-direction: row;
        gap: 5px;
        align-items: baseline;
      }
      body.keyboard-active .stat-label { font-size: 0.7rem; }
      body.keyboard-active .stat-value { font-size: 1rem; }

      /* MAXIMIZE WRITE AREA */
      body.keyboard-active #writeMode {
        display: flex !important;
        flex-direction: column;
        height: 100%;
      }
      body.keyboard-active #writeMode .test-area {
        flex: 1; /* Fill remaining space */
        max-height: none; /* Remove manual limit */
        padding: 1rem;
        margin-bottom: 5px; /* Slight buffer from keyboard */
      }
      
      /* CHARACTER MODE ADJUSTMENT */
      body.keyboard-active #characterMode {
        display: flex !important;
        flex-direction: column;
        justify-content: center;
        height: 100%;
      }
    }
  </style>
</head>
<body>

  <!-- Hidden Input for Mobile Compatibility -->
  <input type="text" id="mobileInput" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">

  <div class="container">
    
    <!-- New TypeTest Header Logo -->
    <div class="typetest-header">
      <span class="material-symbols-rounded typetest-icon">keyboard_alt</span>
      <span class="typetest-title">TypeTest</span>
    </div>

    <!-- Landing Page -->
    <div id="landingPage">
      <p style="margin-bottom: 2rem;">Test your speed and accuracy.</p>
      
      <div class="mode-selector">
        <div class="mode-btn" onclick="setMode('write')">
          <span class="material-symbols-rounded">article</span>
          <h3>Write Mode</h3>
          <small>Press W</small>
        </div>
        <div class="mode-btn" onclick="setMode('character')">
          <span class="material-symbols-rounded">keyboard</span>
          <h3>Character Mode</h3>
          <small>Press C</small>
        </div>
      </div>
      
      <p style="font-size: 0.85rem; opacity: 0.5;">Use physical keyboard or tap to type on mobile.</p>
    </div>

    <!-- Write Mode -->
    <div id="writeMode" style="display: none;">
      <button class="back-btn" onclick="setMode('landing')">
        <span class="material-symbols-rounded" style="font-size:18px;">arrow_back</span> Back
      </button>

      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-label">Time</span>
          <span class="stat-value" id="writeTimer">30</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">WPM</span>
          <span class="stat-value" id="writeWpm">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Accuracy</span>
          <span class="stat-value" id="writeAcc">100%</span>
        </div>
      </div>

      <div class="test-area" id="writeArea">
        <div class="mobile-tap-area" onclick="focusInput()"></div>
        <!-- Cursor is moved inside test-text by JS now -->
        <div class="test-text" id="writeTestText"></div>
      </div>
      
      <p id="writeNotice" style="margin-top: 1.5rem; font-size: 0.9rem;">Tap text to start typing</p>
    </div>

    <!-- Character Mode -->
    <div id="characterMode" style="display: none;">
      <button class="back-btn" onclick="setMode('landing')">
        <span class="material-symbols-rounded" style="font-size:18px;">arrow_back</span> Back
      </button>

      <div class="options-bar">
        <label class="custom-checkbox">
          <input type="checkbox" id="includeNumbersCheckbox" checked>
          <span class="checkbox-box"></span>
          Include Numbers
        </label>
      </div>

      <!-- Helper to focus keyboard on mobile -->
      <div style="position:relative;" onclick="focusInput()">
        <div id="charCarousel"></div>
      </div>

      <div class="stats-bar">
        <div class="stat-item">
          <span class="stat-label">WPM</span>
          <span class="stat-value" id="charWpm">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">CPS</span>
          <span class="stat-value" id="charCps">0.00</span>
        </div>
      </div>

      <div id="fingerDiagram" class="finger-diagram">
        <div class="finger" data-finger="left-pinky">Left Pinky</div>
        <div class="finger" data-finger="left-ring">L-Ring</div>
        <div class="finger" data-finger="left-middle">L-Mid</div>
        <div class="finger" data-finger="left-index">L-Index</div>
        <div class="finger" data-finger="right-index">R-Index</div>
        <div class="finger" data-finger="right-middle">R-Mid</div>
        <div class="finger" data-finger="right-ring">R-Ring</div>
        <div class="finger" data-finger="right-pinky">R-Pinky</div>
      </div>
      
      <p id="charNotice" style="margin-top: 1.5rem; font-size: 0.9rem;">Tap letter to start typing</p>
    </div>

  </div>

  <!-- Branding Moved Out of Box -->
  <div class="brand-footer">
    <svg class="brand-logo" viewBox="0 0 100 60">
        <path d="M5 55 L50 10 L95 55" />
    </svg>
    <span class="brand-name">inhouse software</span>
  </div>

  <script>
    /*******************************************
     * Dual Mode Typing Test (Mobile Friendly)
     *******************************************/
    
    // ----- GLOBAL VARS & HELPERS -----
    let currentMode = "landing";
    const mobileInput = document.getElementById("mobileInput");
    let transitionTimeout = null;
    let isTransitioning = false;
    
    // Focus helper for mobile keyboards
    function focusInput() {
      mobileInput.focus();
      // On mobile, sometimes we need to reset value to avoid autocomplete weirdness
      mobileInput.value = ""; 
    }

    // Toggle body class on focus/blur to handle mobile layout
    mobileInput.addEventListener('focus', () => {
        document.body.classList.add('keyboard-active');
    });
    mobileInput.addEventListener('blur', () => {
        document.body.classList.remove('keyboard-active');
    });

    function setMode(mode) {
      if (currentMode === mode || isTransitioning) return;
      isTransitioning = true;

      const container = document.querySelector('.container');
      
      // Map mode names to DOM IDs
      const oldId = currentMode === 'landing' ? 'landingPage' : currentMode + 'Mode';
      const newId = mode === 'landing' ? 'landingPage' : mode + 'Mode';
      
      const oldEl = document.getElementById(oldId);
      const newEl = document.getElementById(newId);

      // 1. Capture Current Height & Lock It
      const startHeight = container.offsetHeight;
      container.style.height = startHeight + 'px';
      
      // 2. Start Fade Out of Old Content
      oldEl.classList.add('fading-out');

      // 3. Wait for Fade Out to Complete (200ms)
      setTimeout(() => {
        // Hide Old Content
        oldEl.style.display = 'none';
        oldEl.classList.remove('fading-out');
        
        // Clean up previous mode states
        stopWriteMode();
        if (charStatsInterval) {
            clearInterval(charStatsInterval);
            charStatsInterval = null;
        }
        mobileInput.value = "";

        // Set New Mode State
        currentMode = mode;
        if (mode === 'landing') mobileInput.blur();
        
        // Show New Content (CSS animation triggers here)
        newEl.style.display = 'block';
        
        // Init New Logic
        if (mode === 'write') {
            initWriteMode();
            setTimeout(focusInput, 50);
        } else if (mode === 'character') {
            initCharacterMode();
            setTimeout(focusInput, 50);
        }

        // 4. Measure New Content Height
        // Unset height property temporarily to get 'auto' height
        container.style.height = 'auto'; 
        const endHeight = container.offsetHeight;
        
        // Snap back to start height instantly to prepare for transition
        container.style.height = startHeight + 'px';
        void container.offsetHeight; // Force browser reflow
        
        // 5. Animate to New Height
        container.style.height = endHeight + 'px';
        
        // 6. Cleanup Height Lock after Transition (300ms)
        if (transitionTimeout) clearTimeout(transitionTimeout);
        transitionTimeout = setTimeout(() => {
            container.style.height = 'auto';
            isTransitioning = false;
        }, 300);

      }, 200); // Matches CSS fadeOut duration
    }

    // --- EVENT LISTENERS ---
    
    // 1. Physical Keyboard support
    document.addEventListener("keydown", function(e) {
      if (isTransitioning) return;
      if (e.key === "Escape") { setMode("landing"); return; }
      
      // Prevent double handling if focused on input (Input event handles logic)
      if (document.activeElement === mobileInput) return;

      if (currentMode === "character" && e.key === "-") {
        const cb = document.getElementById("includeNumbersCheckbox");
        cb.checked = !cb.checked;
        initCharacterMode();
        return;
      }
      
      // Desktop shortcut keys on landing
      if (currentMode === "landing") {
        if (e.key.toLowerCase() === "w") {
            setMode("write");
            return; 
        }
        if (e.key.toLowerCase() === "c") {
            setMode("character");
            return;
        }
      }
      
      // If not focused on hidden input (desktop usage), handle manually
      if (currentMode === "write") handleWriteKey(e.key);
      else if (currentMode === "character") handleCharacterKey(e.key);
    });

    // 2. Virtual Keyboard / Hidden Input support
    mobileInput.addEventListener("input", (e) => {
      // Get the last character typed
      const val = mobileInput.value;
      if (!val) return; 
      
      const char = val.slice(-1); 
      
      if (currentMode === "write") handleWriteKey(char);
      else if (currentMode === "character") handleCharacterKey(char);
      
      mobileInput.value = ""; 
    });

    // Special handling for Backspace on mobile input
    mobileInput.addEventListener("keydown", (e) => {
      if (e.key === "Backspace") {
        if (currentMode === "write") handleWriteKey("Backspace");
      }
    });

    /* ========= WRITE MODE LOGIC ========= */
    let writeCurrentText = "";
    let writeTypedText = "";
    const writeTimerDuration = 30;
    let writeTimeLeft = writeTimerDuration;
    let writeTimerInterval = null;
    let writeTestStarted = false;
    let writeTestEnded = false;
    let writeStartTime = null;
    
    function generateParagraph(wordCount) {
      const wordPool = [
        'time','person','year','way','day','thing','man','world','life','hand',
        'part','child','eye','woman','place','work','week','case','point','government',
        'company','number','group','problem','fact','night','water','room','mother','area',
        'money','story','friend','love','car','tree','computer','phone','code','program',
        'design','language','art','music','video','film','photo','game','play','park',
        'home','house','city','country','ocean','mountain','river','forest','desert','sky',
        'sun','moon','star','planet','space','universe','energy','force','power','light',
        'dark','wind','fire','earth','metal','glass','stone','wood','air','silver',
        'gold','copper','iron','mercury','diamond','crystal','cloud','rain','snow','ice'
      ];
      let paragraph = [];
      for (let i = 0; i < wordCount; i++) {
        let randomWord = wordPool[Math.floor(Math.random() * wordPool.length)];
        paragraph.push(randomWord);
      }
      return paragraph.join(" ");
    }
    
    function renderWriteTestText() {
      const container = document.getElementById("writeTestText");
      container.innerHTML = "";
      
      // Inject cursor first
      const cursor = document.createElement("div");
      cursor.id = "cursor";
      container.appendChild(cursor);

      const words = writeCurrentText.split(" ");
      words.forEach((word, wIndex) => {
        const wordSpan = document.createElement("span");
        wordSpan.classList.add("word");
        for (let i = 0; i < word.length; i++) {
          const letterSpan = document.createElement("span");
          letterSpan.classList.add("letter");
          letterSpan.textContent = word[i];
          wordSpan.appendChild(letterSpan);
        }
        if (wIndex < words.length - 1) {
          const spaceSpan = document.createElement("span");
          spaceSpan.classList.add("letter");
          spaceSpan.innerHTML = "&nbsp;"; 
          wordSpan.appendChild(spaceSpan);
        }
        container.appendChild(wordSpan);
      });
      requestAnimationFrame(updateCursorPosition);
    }
    
    function updateCursorPosition() {
      const letters = document.querySelectorAll("#writeTestText .letter");
      const cursor = document.getElementById("cursor");
      const container = document.getElementById("writeArea");
      
      if (writeTypedText.length < letters.length) {
        const currentLetter = letters[writeTypedText.length];
        
        // 1. Position Cursor (Relative to text container now)
        cursor.style.left = currentLetter.offsetLeft + 'px';
        cursor.style.top = currentLetter.offsetTop + 'px';
        cursor.style.height = currentLetter.offsetHeight + 'px'; // Match line height
        cursor.style.opacity = 1;
        cursor.style.transform = 'none'; // Clear old transform logic

        // 2. Auto-Scroll Logic
        // Calculate where the cursor is relative to the scroll view
        const letterTop = currentLetter.offsetTop;
        const letterHeight = currentLetter.offsetHeight;
        const scrollTop = container.scrollTop;
        const containerHeight = container.clientHeight;

        // If cursor is below visible area, scroll down
        if (letterTop + letterHeight > scrollTop + containerHeight - 20) {
            container.scrollTo({
                top: letterTop - containerHeight / 2, // Scroll to center active line
                behavior: 'smooth'
            });
        } 
        // If cursor is above visible area (backspace), scroll up
        else if (letterTop < scrollTop + 20) {
             container.scrollTo({
                top: Math.max(0, letterTop - 50),
                behavior: 'smooth'
            });
        }

      } else {
        cursor.style.opacity = 0;
      }
    }
    
    function updateWriteStats() {
      const letters = document.querySelectorAll("#writeTestText .letter");
      let correctCount = 0;
      
      for (let i = 0; i < letters.length; i++) {
        const expected = letters[i].textContent.replace(/\u00a0/, " "); 
        const typedChar = writeTypedText[i];
        letters[i].className = "letter"; 
        
        if (typedChar == null) {
        } else if (typedChar === expected) {
          letters[i].classList.add("correct");
          correctCount++;
        } else {
          letters[i].classList.add("incorrect");
        }
      }
      
      let elapsed = 0;
      if (writeStartTime) elapsed = (Date.now() - writeStartTime) / 1000;
      
      const accuracy = writeTypedText.length ? Math.round((correctCount / writeTypedText.length) * 100) : 100;
      const wpm = elapsed > 0 ? Math.round((correctCount / 5) / (elapsed / 60)) : 0;
      
      document.getElementById("writeWpm").textContent = wpm;
      document.getElementById("writeAcc").textContent = accuracy + "%";
    }
    
    function startWriteTimer() {
      writeTimerInterval = setInterval(() => {
        writeTimeLeft--;
        document.getElementById("writeTimer").textContent = writeTimeLeft;
        if (writeTimeLeft <= 0) {
          endWriteMode();
        }
      }, 1000);
    }
    
    function endWriteMode() {
      clearInterval(writeTimerInterval);
      writeTestEnded = true;
      document.getElementById("writeNotice").textContent = "Test over – Tap restart or press Space";
      mobileInput.blur(); 
      
      const writeModeDiv = document.getElementById("writeMode");
      writeModeDiv.classList.add("write-finished");
    }
    
    function stopWriteMode() {
      clearInterval(writeTimerInterval);
    }
    
    function initWriteMode() {
      writeCurrentText = generateParagraph(40);
      writeTypedText = "";
      writeTimeLeft = writeTimerDuration;
      writeTestStarted = false;
      writeTestEnded = false;
      writeStartTime = null;
      document.getElementById("writeTimer").textContent = writeTimerDuration;
      document.getElementById("writeWpm").textContent = "0";
      document.getElementById("writeAcc").textContent = "100%";
      document.getElementById("writeNotice").textContent = "Tap text to start typing";
      document.getElementById("writeMode").classList.remove("write-finished");
      renderWriteTestText();
    }
    
    function handleWriteKey(key) {
      if (writeTestEnded && key === " ") {
        initWriteMode();
        return;
      }
      if (writeTestEnded) return;
      
      if (!writeTestStarted) {
        writeTestStarted = true;
        writeStartTime = Date.now();
        startWriteTimer();
      }
      
      if (key === "Backspace") {
        writeTypedText = writeTypedText.slice(0, -1);
      } else if (key.length === 1) {
        writeTypedText += key;
      }
      
      updateWriteStats(); 
      updateCursorPosition();
      
      const totalLetters = document.querySelectorAll("#writeTestText .letter").length;
      if (writeTypedText.length >= totalLetters) endWriteMode();
    }
    
    /* ========= CHARACTER MODE LOGIC ========= */
    let charTestStarted = false;
    let charStartTime = null;
    let charCorrectCount = 0;
    let charLastKeyTime = null;
    let charStatsInterval = null;
    let charQueue = [];
    
    function getAllowedChars() {
      const includeNumbers = document.getElementById("includeNumbersCheckbox").checked;
      return includeNumbers ? "abcdefghijklmnopqrstuvwxyz0123456789" : "abcdefghijklmnopqrstuvwxyz";
    }
    
    function getRandomChar() {
      const chars = getAllowedChars();
      return chars[Math.floor(Math.random() * chars.length)];
    }
    
    function renderCarousel() {
      const container = document.getElementById("charCarousel");
      container.innerHTML = "";
      
      const item0 = document.createElement("div");
      item0.className = "charItem center";
      item0.textContent = charQueue[0].toUpperCase();
      
      const item1 = document.createElement("div");
      item1.className = "charItem next";
      item1.textContent = charQueue[1].toUpperCase();
      
      const item2 = document.createElement("div");
      item2.className = "charItem next2";
      item2.textContent = charQueue[2].toUpperCase();
      
      container.appendChild(item0);
      container.appendChild(item1);
      container.appendChild(item2);
      
      updateFingerDiagram(charQueue[0]);
    }
    
    function updateCharStatsContinuous() {
      if (!charTestStarted) return;
      const now = Date.now();
      
      if (now - charLastKeyTime > 3000) {
        charTestStarted = false;
        charStartTime = null;
        charCorrectCount = 0;
        const wpmEl = document.getElementById("charWpm");
        wpmEl.textContent = "0";
        wpmEl.style.color = "var(--text-muted)";
        return;
      } else {
        document.getElementById("charWpm").style.color = "var(--accent-color)";
      }
      
      const elapsed = (now - charStartTime) / 1000;
      const cps = elapsed > 0 ? (charCorrectCount / elapsed).toFixed(2) : "0.00";
      const wpm = elapsed > 0 ? ((charCorrectCount / 5) / (elapsed / 60)).toFixed(0) : "0";
      
      document.getElementById("charWpm").textContent = wpm;
      document.getElementById("charCps").textContent = cps;
    }
    
    function initCharacterMode() {
      charQueue = [getRandomChar(), getRandomChar(), getRandomChar()];
      renderCarousel();
      charTestStarted = false;
      charStartTime = null;
      charCorrectCount = 0;
      charLastKeyTime = null;
      document.getElementById("charWpm").textContent = "0";
      document.getElementById("charCps").textContent = "0.00";
      
      if (charStatsInterval) clearInterval(charStatsInterval);
      charStatsInterval = setInterval(updateCharStatsContinuous, 100);
    }
    
    function handleCharacterKey(key) {
      if (key.length !== 1) return;
      
      if (!charTestStarted) {
        charTestStarted = true;
        charStartTime = Date.now();
      }
      charLastKeyTime = Date.now();
      
      if (key.toLowerCase() === charQueue[0].toLowerCase()) {
        charCorrectCount++;
        shiftCarousel();
      } else {
        const centerItem = document.querySelector(".charItem.center");
        centerItem.classList.remove("shake");
        void centerItem.offsetWidth; 
        centerItem.classList.add("shake");
      }
    }
    
    function shiftCarousel() {
      const container = document.getElementById("charCarousel");
      if (container.children.length < 3) return;
      
      container.removeChild(container.children[0]);
      
      const newCenter = container.children[0];
      newCenter.classList.remove("next");
      newCenter.classList.add("center");
      
      const newNext = container.children[1];
      newNext.classList.remove("next2");
      newNext.classList.add("next");
      
      charQueue.shift();
      const newChar = getRandomChar();
      charQueue.push(newChar);
      
      const newItem = document.createElement("div");
      newItem.className = "charItem enter"; 
      newItem.textContent = newChar.toUpperCase();
      container.appendChild(newItem);
      
      void newItem.offsetWidth; 
      
      newItem.classList.remove("enter");
      newItem.classList.add("next2");
      
      updateFingerDiagram(charQueue[0]);
    }
    
    const fingerMapping = {
      'q': 'left-pinky', 'a': 'left-pinky', 'z': 'left-pinky', '1': 'left-pinky',
      'w': 'left-ring',  's': 'left-ring',  'x': 'left-ring',  '2': 'left-ring',
      'e': 'left-middle','d': 'left-middle','c': 'left-middle','3': 'left-middle',
      'r': 'left-index', 't': 'left-index','f': 'left-index','g': 'left-index',
      'v': 'left-index','b': 'left-index','4': 'left-index','5': 'left-index',
      'y': 'right-index','u': 'right-index','h': 'right-index','j': 'right-index',
      'n': 'right-index','m': 'right-index','6': 'right-index','7': 'right-index',
      'i': 'right-middle','k': 'right-middle','8': 'right-middle',
      'o': 'right-ring', 'l': 'right-ring','9': 'right-ring',
      'p': 'right-pinky','0': 'right-pinky'
    };
    
    function updateFingerDiagram(ch) {
      const fingers = document.querySelectorAll("#fingerDiagram .finger");
      fingers.forEach(finger => finger.classList.remove("active"));
      const fingerKey = fingerMapping[ch.toLowerCase()];
      if (fingerKey) {
        const activeFinger = document.querySelector(`#fingerDiagram .finger[data-finger="${fingerKey}"]`);
        if (activeFinger) activeFinger.classList.add("active");
      }
    }
    
    // Init
    document.getElementById("includeNumbersCheckbox").addEventListener("change", initCharacterMode);
    setMode("landing");
  </script>
</body>
</html>
